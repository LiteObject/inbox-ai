<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inbox AI Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,400,0,0"
        rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}" />
    <script src="{{ url_for('static', path='js/register-sw.js') }}" defer></script>
</head>

<body class="page-root">
    <!-- Abstract Background Shapes Layer -->
    <div class="organic-background" aria-hidden="true">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
        <div class="shape shape-5"></div>
        <div class="shape shape-6"></div>
    </div>

    {% set page_title = 'Inbox AI Dashboard' %}
    {% set show_settings_button = true %}
    {% set show_back_button = false %}
    {% include 'partials/header.html' %}

    <div id="sync-spinner" class="spinner-overlay" hidden>
        <div class="spinner-wrapper" role="status" aria-live="polite">
            <div class="md3-spinner" aria-hidden="true"></div>
            <p id="spinner-message">Processing request...</p>
        </div>
    </div>

    <div id="toast-data" hidden aria-hidden="true" data-sync-status="{{ sync_status | default('', true) }}"
        data-sync-message="{{ sync_message | default('', true) | e }}"
        data-delete-status="{{ delete_status | default('', true) }}"
        data-delete-message="{{ delete_message | default('', true) | e }}"
        data-categorize-status="{{ categorize_status | default('', true) }}"
        data-categorize-message="{{ categorize_message | default('', true) | e }}"
        data-draft-status="{{ draft_status | default('', true) }}"
        data-draft-message="{{ draft_message | default('', true) | e }}"
        data-send-status="{{ send_status | default('', true) }}"
        data-send-message="{{ send_message | default('', true) | e }}"
        data-config-status="{{ config_status | default('', true) }}"
        data-config-message="{{ config_message | default('', true) | e }}"
        data-clear-status="{{ clear_status | default('', true) }}"
        data-clear-message="{{ clear_message | default('', true) | e }}">
    </div>

    <div id="toast-container" class="toast-container" aria-live="assertive" aria-atomic="true"></div>

    <main class="md3-layout">
        <section class="md3-navigation-rail" id="filter-rail">
            <h2>Filters</h2>
            <form class="filter-form" method="get" data-scroll-restore>
                <div class="md3-field">
                    <label for="filter-insights-limit">Insights limit</label>
                    <input class="md3-input" id="filter-insights-limit" type="number" name="insights_limit" min="1"
                        max="100" value="{{ filters.insights_limit }}" />
                </div>

                <div class="md3-field">
                    <label for="filter-priority">Priority</label>
                    <select class="md3-select" id="filter-priority" name="priority">
                        {% for value, label in priority_filter_options %}
                        <option value="{{ value }}" {% if value==filters.priority_filter %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="md3-field">
                    <label for="filter-category">Category</label>
                    <select class="md3-select" id="filter-category" name="category">
                        <option value="" {% if not filters.category_key %}selected{% endif %}>All categories</option>
                        {% for category in category_options %}
                        <option value="{{ category.key }}" {% if filters.category_key==category.key %}selected{% endif
                            %}>
                            {{ category.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="md3-field">
                    <label for="filter-follow-status">Follow-up status</label>
                    <select class="md3-select" id="filter-follow-status" name="follow_status">
                        <option value="open" {% if filters.follow_status_value=='open' %}selected{% endif %}>Open
                            follow-ups</option>
                        <option value="done" {% if filters.follow_status_value=='done' %}selected{% endif %}>Completed
                            follow-ups</option>
                        <option value="all" {% if filters.follow_status_value=='all' %}selected{% endif %}>All statuses
                        </option>
                    </select>
                </div>

                <div class="md3-field">
                    <label for="filter-follow-only">Follow-ups</label>
                    <select class="md3-select" id="filter-follow-only" name="follow_only">
                        <option value="" {% if not filters.follow_only %}selected{% endif %}>Include all insights
                        </option>
                        <option value="1" {% if filters.follow_only %}selected{% endif %}>Only with follow-ups</option>
                    </select>
                </div>

                <div class="filter-actions">
                    <button class="md3-button md3-button--filled" type="submit">
                        <span class="material-icons" aria-hidden="true">filter_list</span>
                        Apply Filters
                    </button>
                </div>
            </form>

            <form class="secondary-form" method="post" action="/emails/bulk-delete" data-scroll-restore data-spinner
                data-spinner-label="Moving emails to trash..."
                data-confirm="Move all listed emails to trash? You can recover them from your trash folder.">
                <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}" />
                <input type="hidden" name="redirect_to" value="{{ redirect_to }}" />
                {% for item in insights %}
                <input type="hidden" name="uids" value="{{ item.uid }}" />
                {% endfor %}
                <button class="md3-button md3-button--tonal" type="submit" title="Move these emails to trash">
                    <span class="material-icons" aria-hidden="true">delete_sweep</span>
                    Delete These Emails
                </button>
            </form>
        </section>

        <section class="md3-main-content">
            <div class="md3-toolbar">
                <div class="toolbar-heading">
                    <h2>Inbox Insights (<span id="insights-visible-count">{{ insights | length }}</span> / {{
                        insights_total | default(0) }})</h2>
                    <p>Tracking {{ total_email_count | default(0) }} messages across your inbox</p>
                </div>
                <div class="toolbar-actions">
                    <form method="post" action="/categories/regenerate" data-scroll-restore data-spinner
                        data-spinner-label="Rebuilding categories...">
                        <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}" />
                        <input type="hidden" name="redirect_to" value="{{ redirect_to }}" />
                        <button class="md3-button md3-button--tonal" type="submit">
                            <span class="material-icons" aria-hidden="true">category</span>
                            Rebuild Categories
                        </button>
                    </form>
                    <form method="post" action="/sync" data-spinner data-scroll-restore
                        data-spinner-label="Sync in progress...">
                        <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}" />
                        <input type="hidden" name="redirect_to" value="{{ redirect_to }}" />
                        <button class="md3-button md3-button--tonal" type="submit">
                            <span class="material-icons" aria-hidden="true">sync</span>
                            Sync Inbox
                        </button>
                    </form>
                </div>
            </div>

            <div class="list-detail-container">
                <aside class="md3-list-pane">
                    <div class="md3-search-bar">
                        <span class="material-icons" aria-hidden="true">search</span>
                        <input id="insights-search" type="search" placeholder="Search emails..."
                            aria-label="Search insights" />
                    </div>
                    <div class="list-meta">
                        <p>Showing <span id="insights-visible-count-2">{{ insights | length }}</span> of
                            {{ insights_total | default(0) }} insights</p>
                        <div class="sort-controls">
                            <button class="sort-button" id="sort-toggle" data-direction="desc"
                                title="Sort by received date (newest first)"
                                aria-label="Sort by received date, currently newest first">
                                <span class="material-icons sort-icon" aria-hidden="true">arrow_downward</span>
                                <span class="sr-only">Toggle sort order</span>
                            </button>
                        </div>
                    </div>

                    <ul class="md3-list email-list" id="email-list">
                        {% for item in insights %}
                        {% set category_labels = item.categories | map(attribute='label') | join(', ') %}
                        {% set list_category_labels = item.categories | map(attribute='label') | join(' ') %}
                        {% set action_text = item.actionItems | join(' ') %}
                        {% set follow_ns = namespace(parts=[]) %}
                        {% for task in item.followUps %}
                        {% set follow_ns.parts = follow_ns.parts + [task.action ~ ' ' ~ task.status] %}
                        {% endfor %}
                        {% set follow_text = follow_ns.parts | join(' ') %}
                        {% set draft_body = item.draft.body if item.draft else '' %}
                        {% set draft_provider = item.draft.provider if item.draft else '' %}
                        {% set draft_fallback = 'true' if item.draft and item.draft.usedFallback else 'false' %}
                        <li>
                            <button type="button" class="email-list-item" data-uid="{{ item.uid }}"
                                data-subject="{{ item.subject | default('', true) | e }}"
                                data-sender="{{ item.sender | default('', true) | e }}"
                                data-summary="{{ item.summary | default('', true) | replace('\n', ' ') | e }}"
                                data-actions="{{ action_text | default('', true) | e }}"
                                data-categories="{{ list_category_labels | default('', true) | e }}"
                                data-priority="{{ item.priorityLabel | default('', true) | e }}"
                                data-priority-value="{{ item.priority }}"
                                data-provider="{{ item.provider | default('', true) | e }}"
                                data-follow="{{ follow_text | default('', true) | e }}"
                                data-has-followups="{{ 'true' if item.followUps else 'false' }}"
                                data-has-draft="{{ 'true' if item.draft else 'false' }}"
                                data-draft="{{ draft_body | default('', true) | replace('\n', ' ') | e }}"
                                data-draft-provider="{{ draft_provider | default('', true) | e }}"
                                data-draft-fallback="{{ draft_fallback }}"
                                data-thread-id="{{ item.threadId | default('', true) | e }}" {% if loop.first %}selected
                                data-selected="true" {% else %}data-selected="false" {% endif %}>
                                {% if item.priority >= 7 %}
                                <span class="material-icons item-icon priority-icon"
                                    aria-hidden="true">error_outline</span>
                                {% elif item.priority >= 4 %}
                                <span class="material-icons item-icon priority-medium"
                                    aria-hidden="true">warning_amber</span>
                                {% else %}
                                <span class="material-icons item-icon" aria-hidden="true">mail</span>
                                {% endif %}
                                <span class="item-content">
                                    <span class="item-headline">{{ item.subject or "(no subject)" }}</span>
                                    <span class="item-supporting">{{ item.sender or "Unknown sender" }}{% if
                                        item.receivedAtDisplay %} Â· {{ item.receivedAtDisplay }}{% endif %}</span>
                                </span>
                            </button>
                        </li>
                        {% endfor %}
                    </ul>

                    <div class="md3-empty-state" id="insights-filter-empty" {% if insights | length> 0 %}hidden{% endif
                        %}>
                        <span class="material-icons" aria-hidden="true">mail_outline</span>
                        <p>No emails found. Try adjusting your filters.</p>
                    </div>
                </aside>

                <section class="md3-detail-pane">
                    <div id="detail-content" aria-live="polite">
                        <div class="md3-empty-state">
                            <span class="material-icons" aria-hidden="true">mail_outline</span>
                            <p>Select an email to view its details.</p>
                        </div>
                    </div>

                    <div id="detail-templates" hidden>
                        {% for item in insights %}
                        {% set thread_members = insights | selectattr('threadId', 'equalto', item.threadId) |
                        map(attribute='uid') | list %}
                        <template data-email-detail data-uid="{{ item.uid }}">
                            <article class="md3-detail-view detail-view">
                                <header class="md3-detail-header">
                                    <div class="md3-detail-title-section">
                                        <h3>{{ item.subject or "(no subject)" }}</h3>
                                        <div class="md3-detail-meta-extended">
                                            <div class="meta-row">
                                                <span class="material-icons" aria-hidden="true">person</span>
                                                <span>{{ item.sender or "Unknown sender" }}</span>
                                            </div>
                                            <div class="meta-row">
                                                <span class="material-icons" aria-hidden="true">schedule</span>
                                                <span>{{ item.receivedAtDisplay or "Not available" }}</span>
                                            </div>
                                            <div class="meta-row">
                                                <span class="material-icons" aria-hidden="true">flag</span>
                                                <span>{{ item.priorityLabel }} ({{ item.priority }})</span>
                                            </div>
                                            {% if item.threadId and thread_members | length > 1 %}
                                            <div class="meta-row">
                                                <span class="material-icons" aria-hidden="true">forum</span>
                                                <span>{{ thread_members | length }} message{% if thread_members | length
                                                    != 1 %}s{% endif %}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% if item.categories %}
                                        <div class="md3-chip-set">
                                            {% for category in item.categories %}
                                            <span class="md3-chip">{{ category.label }}</span>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <form method="post" action="/emails/{{ item.uid }}/delete" data-scroll-restore
                                        data-spinner
                                        data-confirm="Move this email to trash? You can recover it from your trash folder.">
                                        <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}" />
                                        <input type="hidden" name="redirect_to" value="{{ redirect_to }}" />
                                        <button class="md3-button md3-button--tonal" type="submit"
                                            title="Move to trash">
                                            <span class="material-icons" aria-hidden="true">delete</span>
                                            Delete Email
                                        </button>
                                    </form>
                                </header>

                                <div class="md3-detail-section md3-detail-section--tabs">
                                    <div class="md3-tabs" role="tablist">
                                        <button class="md3-tab md3-tab--active" role="tab" aria-selected="true"
                                            aria-controls="summary-panel-{{ item.uid }}" id="summary-tab-{{ item.uid }}"
                                            data-tab="summary">
                                            <span class="md3-tab__content">
                                                <span class="material-icons" aria-hidden="true">summarize</span>
                                                <span class="md3-tab__text-label">Summary</span>
                                            </span>
                                            <span class="md3-tab__indicator"></span>
                                        </button>

                                        <button class="md3-tab" role="tab" aria-selected="false"
                                            aria-controls="original-panel-{{ item.uid }}"
                                            id="original-tab-{{ item.uid }}" data-tab="original" tabindex="-1">
                                            <span class="md3-tab__content">
                                                <span class="material-icons" aria-hidden="true">mail</span>
                                                <span class="md3-tab__text-label">Original Email</span>
                                            </span>
                                            <span class="md3-tab__indicator"></span>
                                        </button>
                                    </div>

                                    <div class="md3-tab-panels">
                                        <!-- Summary Panel (Default Active) -->
                                        <div class="md3-tab-panel md3-tab-panel--active" role="tabpanel"
                                            id="summary-panel-{{ item.uid }}"
                                            aria-labelledby="summary-tab-{{ item.uid }}">

                                            <div class="md3-detail-subsection">
                                                <h4>
                                                    <span class="material-icons" aria-hidden="true">smart_toy</span>
                                                    AI Summary
                                                </h4>
                                                <p>{{ item.summary or "No summary available for this email." }}</p>
                                            </div>

                                            {% if item.actionItems %}
                                            <div class="md3-detail-subsection">
                                                <h4>
                                                    <span class="material-icons" aria-hidden="true">flag</span>
                                                    Key Actions
                                                </h4>
                                                <ul class="md3-detail-list">
                                                    {% for action in item.actionItems %}
                                                    <li>
                                                        <span class="material-icons" aria-hidden="true">task_alt</span>
                                                        <span>{{ action }}</span>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <!-- Original Email Panel -->
                                        <div class="md3-tab-panel" role="tabpanel" id="original-panel-{{ item.uid }}"
                                            aria-labelledby="original-tab-{{ item.uid }}" hidden>

                                            <div class="email-original">
                                                <div class="email-meta">
                                                    <dl>
                                                        <dt>From:</dt>
                                                        <dd>{{ item.sender or "Unknown sender" }}</dd>

                                                        <dt>Subject:</dt>
                                                        <dd>{{ item.subject or "(no subject)" }}</dd>

                                                        <dt>Received:</dt>
                                                        <dd>{{ item.receivedAtDisplay or "Not available" }}</dd>
                                                    </dl>
                                                </div>

                                                <div class="email-body" data-uid="{{ item.uid }}">
                                                    <div class="loading-placeholder">
                                                        <div class="md3-circular-progress" role="status"
                                                            aria-label="Loading email content">
                                                            <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                                                <circle cx="24" cy="24" r="18" fill="none"
                                                                    stroke-width="4"></circle>
                                                            </svg>
                                                        </div>
                                                        <span class="sr-only">Loading email content...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <section class="md3-detail-section">
                                    <h4>
                                        <span class="material-icons" aria-hidden="true">assignment_turned_in</span>
                                        Follow-up Tasks
                                    </h4>
                                    {% if item.followUps %}
                                    <ul class="md3-detail-list">
                                        {% for task in item.followUps %}
                                        <li>
                                            <span class="material-icons" aria-hidden="true">schedule</span>
                                            <span class="item-content">
                                                <span class="item-headline">{{ task.action }}</span>
                                                <span class="item-supporting">{% if task.dueAt %}Due {{ task.dueAt }}{%
                                                    else %}No due date{% endif %}</span>
                                            </span>
                                            <form method="post" action="/follow-ups/{{ task.id }}/status"
                                                data-scroll-restore data-spinner>
                                                <input type="hidden" name="{{ csrf_field_name }}"
                                                    value="{{ csrf_token }}" />
                                                <input type="hidden" name="redirect_to" value="{{ redirect_to }}" />
                                                <input type="hidden" name="status"
                                                    value="{% if task.status == 'done' %}open{% else %}done{% endif %}" />
                                                {% if task.status == 'done' %}
                                                <button class="md3-button md3-button--tonal" type="submit">
                                                    <span class="material-icons" aria-hidden="true">undo</span>
                                                    Reopen
                                                </button>
                                                {% else %}
                                                <button class="md3-button md3-button--tonal" type="submit">
                                                    <span class="material-icons" aria-hidden="true">check_circle</span>
                                                    Complete
                                                </button>
                                                {% endif %}
                                            </form>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <p>No follow-up tasks tracked for this email.</p>
                                    {% endif %}
                                </section>

                                <section class="md3-detail-section">
                                    <h4>
                                        <span class="material-icons" aria-hidden="true">edit_note</span>
                                        Draft Reply
                                    </h4>
                                    <form method="post" action="/emails/{{ item.uid }}/draft" data-scroll-restore
                                        data-spinner>
                                        <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}" />
                                        <input type="hidden" name="redirect_to" value="{{ redirect_to }}" />
                                        <input type="hidden" name="draft_id"
                                            value="{{ item.draft.id if item.draft and item.draft.id else '' }}" />
                                        <input type="hidden" name="provider"
                                            value="{{ item.draft.provider if item.draft and item.draft.provider else 'manual-edit' }}" />
                                        <textarea class="md3-textarea" name="body" rows="10"
                                            placeholder="Update the suggested reply before saving">{{ (item.draft.body if item.draft else '') | e }}</textarea>
                                        <div class="md3-draft-actions">
                                            <button class="md3-button md3-button--filled" type="submit">
                                                <span class="material-icons" aria-hidden="true">save</span>
                                                Save Draft
                                            </button>
                                            {% if item.draft %}
                                            <button class="md3-button md3-button--filled md3-button--primary"
                                                type="submit" formaction="/emails/{{ item.uid }}/draft/send"
                                                data-confirm="Send this email reply?">
                                                <span class="material-icons" aria-hidden="true">send</span>
                                                Send Reply
                                            </button>
                                            <button class="md3-button md3-button--tonal" type="submit"
                                                formaction="/emails/{{ item.uid }}/draft/regenerate">
                                                <span class="material-icons" aria-hidden="true">auto_fix_high</span>
                                                Regenerate
                                            </button>
                                            <button class="md3-button md3-button--tonal" type="submit"
                                                formaction="/emails/{{ item.uid }}/draft/delete">
                                                <span class="material-icons" aria-hidden="true">delete_outline</span>
                                                Delete Draft
                                            </button>
                                            {% else %}
                                            <button class="md3-button md3-button--tonal" type="submit"
                                                formaction="/emails/{{ item.uid }}/draft/regenerate">
                                                <span class="material-icons" aria-hidden="true">auto_fix_high</span>
                                                Generate
                                            </button>
                                            {% endif %}
                                        </div>
                                    </form>
                                </section>
                            </article>
                        </template>
                        {% endfor %}
                    </div>
                </section>
            </div>
        </section>
    </main>

    <!-- Floating Action Button for Compose -->
    <button class="md3-fab md3-fab--primary" id="compose-fab" type="button" aria-label="Compose new email"
        title="Compose new email">
        <span class="material-icons" aria-hidden="true">edit</span>
    </button>

    <!-- Compose Email Modal Dialog -->
    <dialog id="compose-dialog" class="compose-dialog">
        <form method="post" action="/emails/send" id="compose-form" class="compose-dialog__form" data-spinner>
            <header class="compose-dialog__header">
                <h2 class="compose-dialog__title">New Message</h2>
                <button type="button" class="md3-icon-button close-dialog" aria-label="Close dialog">
                    <span class="material-icons" aria-hidden="true">close</span>
                </button>
            </header>

            <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}" />
            <input type="hidden" name="redirect_to" value="{{ redirect_to }}" />

            <div class="compose-dialog__content">
                <div class="md3-text-field">
                    <input type="email" id="compose-to" name="to" class="md3-text-field__input" required placeholder=" "
                        autocomplete="email" />
                    <label for="compose-to" class="md3-text-field__label">To</label>
                </div>

                <div class="md3-text-field">
                    <input type="text" id="compose-subject" name="subject" class="md3-text-field__input" required
                        placeholder=" " autocomplete="off" />
                    <label for="compose-subject" class="md3-text-field__label">Subject</label>
                </div>

                <div class="md3-text-field">
                    <textarea id="compose-body" name="body"
                        class="md3-text-field__input md3-text-field__input--textarea" rows="8" required
                        placeholder=" "></textarea>
                    <label for="compose-body" class="md3-text-field__label">Message</label>
                </div>
            </div>

            <footer class="compose-dialog__actions">
                <button type="button" class="md3-button md3-button--text cancel-compose">
                    Cancel
                </button>
                <button type="submit" class="md3-button md3-button--filled md3-button--primary">
                    <span class="material-icons" aria-hidden="true">send</span>
                    <span>Send</span>
                </button>
            </footer>
        </form>
    </dialog>

    <!-- Confirmation Dialog -->
    <dialog id="confirm-dialog" class="confirm-dialog">
        <div class="confirm-dialog__container">
            <header class="confirm-dialog__header">
                <span class="material-icons confirm-dialog__icon" aria-hidden="true">help_outline</span>
                <h3 class="confirm-dialog__title">Send Email?</h3>
            </header>
            <div class="confirm-dialog__content">
                <p id="confirm-dialog-message">Are you sure you want to send this email?</p>
            </div>
            <footer class="confirm-dialog__actions">
                <button type="button" class="md3-button md3-button--text" id="confirm-cancel">
                    Cancel
                </button>
                <button type="button" class="md3-button md3-button--filled md3-button--primary" id="confirm-ok">
                    Send
                </button>
            </footer>
        </div>
    </dialog>

    <script src="{{ url_for('static', path='js/tabs.js') }}"></script>
    <script src="{{ url_for('static', path='js/compose.js') }}"></script>
    <script type="module" src="{{ url_for('static', path='js/dashboard.js') }}"></script>
</body>

</html>